<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin å¾Œå°</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
  <h1>ğŸ“¢ Admin å¾Œå°</h1>

  <!-- ä½¿ç”¨è€…åˆ—è¡¨ -->
  <h2>ä½¿ç”¨è€…åˆ—è¡¨</h2>
  <table border="1" id="userTable">
    <tr><th>IP</th><th>ç‹€æ…‹</th><th>å–®ç™¼</th></tr>
  </table>

  <!-- ç¾¤ç™¼é€šçŸ¥ -->
  <h2>ç¾¤ç™¼é€šçŸ¥</h2>
  <input type="text" id="title" placeholder="æ¨™é¡Œ"><br><br>
  <textarea id="message" placeholder="å…§å®¹"></textarea><br><br>
  <input type="text" id="image" placeholder="åœ–ç‰‡ URL (é¸å¡«)"><br><br>
  <button id="sendAll">ç¾¤ç™¼é€šçŸ¥</button>

  <!-- VAPID é‡‘é‘° -->
  <h2>VAPID é‡‘é‘°</h2>
  <p>Public Key: <span id="vapidPublic"></span></p>
  <p>Private Key: <span id="vapidPrivate"></span></p>
</div>

<script>
async function loadUsers(){
  const res = await fetch('/users');
  const data = await res.json();
  const table = document.getElementById('userTable');
  table.innerHTML = '<tr><th>IP</th><th>ç‹€æ…‹</th><th>å–®ç™¼</th></tr>';
  data.forEach(u=>{
    const tr = document.createElement('tr');
    tr.innerHTML=`<td>${u.ip}</td><td>${u.status}</td>
    <td><button onclick="sendSingle('${u.ip}')">å–®ç™¼</button></td>`;
    table.appendChild(tr);
  });
}

async function sendSingle(ip){
  const title = prompt('é€šçŸ¥æ¨™é¡Œ','å–®ç™¼é€šçŸ¥');
  const msg = prompt('å…§å®¹','æ¸¬è©¦è¨Šæ¯');
  const img = prompt('åœ–ç‰‡ URL (é¸å¡«)','');
  await fetch('/sendNotification',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ip,title,message:msg,image:img})
  });
  alert('å–®ç™¼å®Œæˆ');
  loadUsers();
}

document.getElementById('sendAll').addEventListener('click', async ()=>{
  const title = document.getElementById('title').value || 'é€šçŸ¥';
  const msg = document.getElementById('message').value || 'å…§å®¹';
  const img = document.getElementById('image').value || '';
  await fetch('/sendNotification',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({title,message:msg,image:img})
  });
  alert('ç¾¤ç™¼å®Œæˆ');
  loadUsers();
});

async function loadVapidKeys() {
  const res = await fetch('/vapidKeys');
  const data = await res.json();
  document.getElementById('vapidPublic').textContent = data.publicKey;
  document.getElementById('vapidPrivate').textContent = data.privateKey;
}

loadUsers();
loadVapidKeys();
</script>
</body>
</html>
